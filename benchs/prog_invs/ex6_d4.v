Require Import Reals.
Local Open Scope R_scope.
From ValidSDP Require Import validsdp.

(* Attempt to prove that p >= 0 with p below is an
 * inductive invariant, for the program
 *
x1 = rand(0.9, 1.1);
x2 = rand(0, 0.2);
x3 = rand(0, 0.2);
x4 = rand(0, 0.2);
while (-1 <= 0) {
  pre_x1 = x1; pre_x2 = x2; pre_x3 = x3; pre_x4 = x4;
  if (x1^2 + x2^2 + x3^2 + x4^2 <= 1) {
    x1 = 0.25 * (0.8 * pre_x1^2 + 1.4 * pre_x2 - 0.5 * pre_x3^2);
    x2 = 0.25 * (1.3 * pre_x1 + 0.5 * pre_x2^2 - 0.8 * pre_x4^2);
    x3 = 0.25 * (0.8 * pre_x3^2 + 1.4 * pre_x4);
    x4 = 0.25 * (1.3 * pre_x3 + 0.5 * pre_x4^2);
  } else {
    x1 = 0.25 * (0.5 * pre_x1 + 0.4 * pre_x2^2);
    x2 = 0.25 * (-0.6 * pre_x1^2 + 0.3 * pre_x2^2);
    x3 = 0.25 * (0.5 * pre_x3 + 0.4 * pre_x4^2);
    x4 = 0.25 * (-0.6 * pre_x3 + 0.3 * pre_x4^2);
  }
}
 *)

(* initial condition 0.9 <= x1 <= 1.1 encoded as (x1 - 0.9)*(1.1 - x1) (>= 0) *)
Let pI1 (x0 x1 x2 x3 : R) := (x0 - 9 / 10) * (11 / 10 - x0).
(* initial condition 0 <= x2 <= 0.2 *)
Let pI2 (x0 x1 x2 x3 : R) := x1 * (2 / 10 - x1).
(* initial condition 0 <= x3 <= 0.2 *)
Let pI3 (x0 x1 x2 x3 : R) := x2 * (2 / 10 - x2).
(* initial condition 0 <= x4 <= 0.2 *)
Let pI4 (x0 x1 x2 x3 : R) := x3 * (2 / 10 - x3).
(* guard x1^2 + x2^2 + x3^2 + x4^2 <= 1 (then branch) *)
Let g0 (x0 x1 x2 x3 : R) := 1 - (x0^2 + x1^2 + x2^2 + x3^2).
(* assignment in then branch *)
Let t0_x0 (x0 x1 x2 x3 : R) := 1 / 4 * (8 / 10 * x0^2 + 14 / 10 * x1 - 5 / 10 * x2^2).
Let t0_x1 (x0 x1 x2 x3 : R) := 1 / 4 * (13 / 10 * x0 + 5 / 10 * x1^2 - 8 / 10 * x3^2).
Let t0_x2 (x0 x1 x2 x3 : R) := 1 / 4 * (8 / 10 * x2^2 + 14 / 10 * x3).
Let t0_x3 (x0 x1 x2 x3 : R) := 1 / 4 * (13 / 10 * x2 + 5 / 10 * x3^2).

(* guard x1^2 + x2^2 + x3^2 + x4^2 >= 1 (else branch) *)
Let g1 (x0 x1 x2 x3 : R) := (x0^2 + x1^2 + x2^2 + x3^2) - 1.
(* assignment in else branch *)
Let t1_x0 (x0 x1 x2 x3 : R) := 1 / 4 * (5 / 10 * x0 + 4 / 10 * x1^2).
Let t1_x1 (x0 x1 x2 x3 : R) := 1 / 4 * ((-6) / 10 * x0^2 + 3 / 10 * x1^2).
Let t1_x2 (x0 x1 x2 x3 : R) := 1 / 4 * (5 / 10 * x2 + 4 / 10 * x3^2).
Let t1_x3 (x0 x1 x2 x3 : R) := 1 / 4 * ((-6) / 10 * x2 + 3 / 10 * x3^2).

Let p x0 x1 x2 x3 :=
  48940054069273278153/36893488147419103232
  + 5694253208528417/36893488147419103232 * x0
  + 8102901656505047/73786976294838206464 * x1
  + 6269474379387387/147573952589676412928 * x2
  + 3441584900231701/73786976294838206464 * x3
  + -4669554109426427/4503599627370496 * x0^2
  + 92085480506231/288230376151711744 * x0 * x1
  + -5598335104289841/4503599627370496 * x1^2
  + 1843119203387555/9007199254740992 * x0 * x2
  + 1461108288648583/9007199254740992 * x1 * x2
  + -8892369674005945/4503599627370496 * x2^2
  + 3683663009832627/18014398509481984 * x0 * x3
  + 4279969919285975/144115188075855872 * x1 * x3
  + 4599270683968915/4503599627370496 * x2 * x3
  + -2426931813006713/1125899906842624 * x3^2
  + 5679646795147455/288230376151711744 * x0^3
  + 6898152399613459/288230376151711744 * x0^2 * x1
  + 7964854552138401/288230376151711744 * x0 * x1^2
  + -7996748256319621/288230376151711744 * x1^3
  + -3558136104620279/72057594037927936 * x0^2 * x2
  + -8703141464088499/288230376151711744 * x0 * x1 * x2
  + -6898701029652147/144115188075855872 * x1^2 * x2
  + 1876121044027675/2251799813685248 * x0 * x2^2
  + -4463283652912723/18014398509481984 * x1 * x2^2
  + -2162885693276891/72057594037927936 * x2^3
  + -5398056230914363/72057594037927936 * x0^2 * x3
  + 5474141078075247/72057594037927936 * x0 * x1 * x3
  + 5834256714415749/288230376151711744 * x1^2 * x3
  + -8201190208057061/4503599627370496 * x0 * x2 * x3
  + 5783137378410261/9007199254740992 * x1 * x2 * x3
  + 4519517124910863/72057594037927936 * x2^2 * x3
  + 5564976919447915/4503599627370496 * x0 * x3^2
  + -4032767964075663/9007199254740992 * x1 * x3^2
  + -5705740165923223/36028797018963968 * x2 * x3^2
  + 5632093774890191/36028797018963968 * x3^3
  + -5678805155964555/576460752303423488 * x0^4
  + 7449854677957833/576460752303423488 * x0^3 * x1
  + -2627994069062625/576460752303423488 * x0^2 * x1^2
  + 8725945813410821/18446744073709551616 * x0 * x1^3
  + -8911675626378479/9223372036854775808 * x1^4
  + 5585412167840481/1152921504606846976 * x0^3 * x2
  + -4131646996160293/576460752303423488 * x0^2 * x1 * x2
  + 7067301336180357/576460752303423488 * x0 * x1^2 * x2
  + -444139637288545/144115188075855872 * x1^3 * x2
  + -549762786449193/2251799813685248 * x0^2 * x2^2
  + 239478656343597/2251799813685248 * x0 * x1 * x2^2
  + -1878441530106213/18014398509481984 * x1^2 * x2^2
  + 4223954103278339/72057594037927936 * x0 * x2^3
  + -3983274901088115/72057594037927936 * x1 * x2^3
  + -2592136743387799/4503599627370496 * x2^4
  + 1611594838859253/288230376151711744 * x0^3 * x3
  + 7250209135848541/4611686018427387904 * x0^2 * x1 * x3
  + -1227179578630901/144115188075855872 * x0 * x1^2 * x3
  + -2073325184724095/9223372036854775808 * x1^3 * x3
  + 5365581902893101/9007199254740992 * x0^2 * x2 * x3
  + -8972440832492619/36028797018963968 * x0 * x1 * x2 * x3
  + 4571320738466443/18014398509481984 * x1^2 * x2 * x3
  + -5260570922044893/288230376151711744 * x0 * x2^2 * x3
  + 5786032707896575/72057594037927936 * x1 * x2^2 * x3
  + 5865540286708361/2251799813685248 * x2^3 * x3
  + -465574218383891/1125899906842624 * x0^2 * x3^2
  + 3181253618894765/18014398509481984 * x0 * x1 * x3^2
  + -6165504408072355/36028797018963968 * x1^2 * x3^2
  + -8236815771369237/36028797018963968 * x0 * x2 * x3^2
  + 1131632067628285/18014398509481984 * x1 * x2 * x3^2
  + -5528298683556665/1125899906842624 * x2^2 * x3^2
  + 8301825989304093/36028797018963968 * x0 * x3^3
  + -4013672348018387/36028797018963968 * x1 * x3^3
  + 2626355412004073/562949953421312 * x2 * x3^3
  + -4180528354014335/2251799813685248 * x3^4.
  
Theorem init (x0 x1 x2 x3 : R) :
  pI1 x0 x1 x2 x3 >= 0 -> pI2 x0 x1 x2 x3 >= 0 ->
  pI3 x0 x1 x2 x3 >= 0 -> pI4 x0 x1 x2 x3 >= 0 ->
  p x0 x1 x2 x3 >= 0.
Proof.
unfold pI1, pI2, pI3, pI4, p.
validsdp.
Qed.

Theorem ind0 (x0 x1 x2 x3 : R) :
  p x0 x1 x2 x3 >= 0 -> g0 x0 x1 x2 x3 >= 0 -> 
  p (t0_x0 x0 x1 x2 x3) (t0_x1 x0 x1 x2 x3) (t0_x2 x0 x1 x2 x3) (t0_x3 x0 x1 x2 x3) >= 0.
Proof.
unfold p, g0, t0_x0, t0_x1, t0_x2, t0_x3.
validsdp.
Qed.

Theorem ind1 (x0 x1 x2 x3 : R) :
  p x0 x1 x2 x3 >= 0 -> g1 x0 x1 x2 x3 >= 0 ->
  p (t1_x0 x0 x1 x2 x3) (t1_x1 x0 x1 x2 x3) (t1_x2 x0 x1 x2 x3) (t1_x3 x0 x1 x2 x3) >= 0.
Proof.
unfold p, g1, t1_x0, t1_x1, t1_x2, t1_x3.
validsdp.
Qed.
