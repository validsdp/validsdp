Require Import Reals.
Local Open Scope R_scope.
From ValidSDP Require Import validsdp.

(* Attempt to prove that p >= 0 with p below is an
 * inductive invariant, for the program
 *
x1 = rand(0.5, 0.7);
x2 = rand(0.5, 0.7);
while (-1 <= 0) {
  pre_x1 = x1; pre_x2 = x2;
  if (x1^2 + x2^2 <= 1) {
    x1 = pre_x1^2 + pre_x2^3;
    x2 = pre_x1^3 + pre_x2^2;
  } else {
    x1 = 0.5 * pre_x1^3 + 0.4 * pre_x2^2;
    x2 = -0.6 * pre_x1^2 + 0.3 * pre_x2^2;
  }
}
 *)

(* initial condition 0.5 <= x1 <= 0.7 encoded as (x1 - 0.5)*(0.7 - x1) (>= 0) *)
Let pI1 (x0 x1 : R) := (x0 - 5 / 10) * (7 / 10 - x0).
(* initial condition 0.5 <= x2 <= 0.7 *)
Let pI2 (x0 x1 : R) := (x1 - 5 / 10) * (7 / 10 - x1).
(* guard x1^2 + x2^2 <= 1 (then branch) *)
Let g0 x0 x1 := 1 - (x0^2 + x1^2).
(* assignment in then branch *)
Let t0_x0 (x0 x1 : R) := x0^2 + x1^3.
Let t0_x1 (x0 x1 : R) := x0^3 + x1^2.
(* guard x1^2 + x2^2 >= 1 (else branch) *)
Let g1 x0 x1 := (x0^2 + x1^2) - 1.
(* assignment in else branch *)
Let t1_x0 (x0 x1 : R) := 5 / 10 * x0^3 + 4 / 10 * x1^2.
Let t1_x1 (x0 x1 : R) := (-6) / 10 * x0^2 + 3 / 10 * x1^2.

Let p x0 x1 :=
  128676781657/35184372088832 + 5936533188087895/1152921504606846976 * 
  x0 + -5230768883648489/18446744073709551616 * x1
  + -7219569841125045/288230376151711744 * x0^2
  + 6762644639133095/1152921504606846976 * x0 * x1
  + -1394133347692873/144115188075855872 * x1^2
  + 856506940949991/72057594037927936 * x0^3
  + -507149751329383/36028797018963968 * x0^2 * x1
  + 8312134809735735/576460752303423488 * x0 * x1^2
  + 8438999796757737/288230376151711744 * x1^3
  + -2814603216904403/288230376151711744 * x0^4
  + -1982831447875497/9223372036854775808 * x0^3 * x1
  + 8922750143978795/288230376151711744 * x0^2 * x1^2
  + 179041025134977/72057594037927936 * x0 * x1^3
  + -3249250773001133/72057594037927936 * x1^4.
  
Let init_sigma1 x0 x1 :=
  7019264510689479/72057594037927936
  + -7024791364135575/72057594037927936 * x0
  + -2935817909816531/36028797018963968 * x1
  + 6509361164813447/36028797018963968 * x0^2
  + -2959264899769387/36028797018963968 * x0 * x1
  + 5611325041580107/36028797018963968 * x1^2.
  
Let init_sigma2 x0 x1 :=
  1620172820685253/18014398509481984
  + -7535312143315291/72057594037927936 * x0
  + -6233911130111195/72057594037927936 * x1
  + 2597590236502567/18014398509481984 * x0^2
  + -6610391564740097/72057594037927936 * x0 * x1
  + 7429967200179683/36028797018963968 * x1^2.
  
Theorem init (x0 x1 : R) :
  pI1 x0 x1 >= 0 -> pI2 x0 x1 >= 0 ->
  p x0 x1 >= 0.
Proof.
unfold pI1, pI2, p.
validsdp.
Qed.

Theorem ind0 (x0 x1 : R) :
  p x0 x1 >= 0 -> g0 x0 x1 >= 0 -> 
  p (t0_x0 x0 x1) (t0_x1 x0 x1) >= 0.
Proof.
unfold p, g0, t0_x0, t0_x1.
validsdp.
Qed.

Theorem ind1 (x0 x1 : R) :
  p x0 x1 >= 0 -> g1 x0 x1 >= 0 ->
  p (t1_x0 x0 x1) (t1_x1 x0 x1) >= 0.
Proof.
unfold p, g1, t1_x0, t1_x1.
validsdp.
Qed.
