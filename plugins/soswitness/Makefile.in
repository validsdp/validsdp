NAME = @PACKAGE_NAME@
MODULES_BASE :=\
  src/soswitness.ml4\
  src/soswitness.mllib\
  theories/soswitness.v\
  test-suite/soswitnesstac.v
MODULE_SDPA :=\
  test-suite/soswitnesstac_sdpa.v

ifeq (@SDPA_AVAILABLE@,true)
MODULES := $(MODULES_BASE) $(MODULE_SDPA)
else
MODULES := $(MODULES_BASE)
endif

all: Makefile.coq
	$(MAKE) -f Makefile.coq

src/soswitness.ml4: src/soswitness_@COQ_VERSION@.ml4
	rm -f $@
	cp $< $@
	chmod a-w $@

Makefile.coq: Makefile $(MODULES)
	@ocamlfind query zarith >/dev/null
	@ocamlfind query osdp >/dev/null
	@ocamlfind query ocplib-simplex >/dev/null
	coq_makefile -I src \
	  -I "$(shell ocamlfind query zarith)" -I "$(shell ocamlfind query ocplib-simplex)" -I "$(shell ocamlfind query osdp)" \
	  -R theories $(NAME) $(MODULES) -o $@
	sed -e 's/-linkall -shared -o $$@ $$</-linkall -shared -o $$@ zarith.cmxa ocplibSimplex.cmxa osdp.cmxa $$</' -i $@

install: Makefile.coq
	$(MAKE) -f Makefile.coq install

clean: Makefile.coq
	-$(MAKE) -f Makefile.coq clean
	rm -f Makefile.coq Makefile.coq.conf

dist: $(MODULES) Makefile
	T=$$(mktemp -d ../../dist1.XXX) && S=$$T/plugins/soswitness && mkdir -p $$S && rsync -rlpgoDvR $^ $$S && rm -f ../../dist1 && ln -rsv $$T ../../dist1

.PHONY: all clean install dist
