dist: trusty
sudo: required

language: generic

services:
  - docker

env:
  global:
  - NJOBS="2"
  - MULTINOM_URL="https://github.com/math-comp/multinomials.git"
  - MULTINOM_VERSION="5b46e50983ee68dd1b6932e7e4a3bfc1113e7360"
  - PARAMCOQ_URL="https://github.com/aa755/paramcoq.git"
  - COQEAL_URL="https://github.com/CoqEAL/CoqEAL.git"
  - COQEAL_VERSION="d205c98bc36e284759956bee6c8886d548e2e9d0"
  matrix:
  - COQ_IMAGE="erikmd/coq:8.7.2_mathcomp-1.7.0" PARAMCOQ_VERSION="b824b9bbc01e9b9d901efe445186270d6ae85b78"
  - COQ_IMAGE="erikmd/coq:8.8.1_mathcomp-1.7.0" PARAMCOQ_VERSION="760bd033bc12c94a6d68588691aebe04be2ab1cd"

install: |
  # Prepare the coq-deps docker image with all dependencies
  # In case of no-output timeout, prepend "travis_wait" to:
  docker run --name=COQ ${COQ_IMAGE} /bin/bash --login -c "
    # pass --login so we can use “travis_retry” and omit “opam config exec --”
    # and this bash script is double-quoted to interpolate Travis CI env vars:
    echo \"Build triggered by ${TRAVIS_EVENT_TYPE}\"
    export PS4='+ \e[33;1m(\$0 @ line \$LINENO) \$\e[0m '
    set -e # exit on failure
    set -x # trace for debug
    travis_retry sudo apt-get update -y -q # mandatory before “opam depext -i”
    travis_retry opam depext -i -y conf-gmp.1 conf-sdpa.1
    sudo apt-get clean && sudo rm -rf /var/lib/apt/lists/* # optional
    opam install -y -j ${NJOBS} coq-flocq.3.0.0 coq-interval.3.4.0 osdp camlp4
    : Building Multinomials...
    git clone -n ${MULTINOM_URL} ~coq/multinomials
    cd ~coq/multinomials
    git checkout ${MULTINOM_VERSION}
    make Makefile.coq && make -f Makefile.coq -j ${NJOBS} all && make install
    : Building Paramcoq...
    git clone -n ${PARAMCOQ_URL} ~coq/paramcoq
    cd ~coq/paramcoq
    git checkout ${PARAMCOQ_VERSION}
    make Makefile.coq && make -f Makefile.coq -j ${NJOBS} all && make install
    : Building CoqEAL...
    git clone -n ${COQEAL_URL} ~coq/coqeal
    cd ~coq/coqeal
    git checkout ${COQEAL_VERSION}
    pushd theory && make Makefile.coq && make -f Makefile.coq -j ${NJOBS} all && make install && popd
    pushd refinements && make Makefile.coq && make -f Makefile.coq -j ${NJOBS} && make install && popd
    echo 'Install done.'"
  docker commit COQ coq-deps
  docker rm COQ

script: |
  travis_fold start validsdp && echo -en "${ANSI_YELLOW}Building ValidSDP...${ANSI_RESET}"
  docker run --rm -v ${TRAVIS_BUILD_DIR}:/home/coq/validsdp coq-deps /bin/bash --login -c "
    export PS4='+ \e[33;1m(\$0 @ line \$LINENO) \$\e[0m '
    set -e # exit on failure
    set -x # trace for debug
    sudo chown -R coq:coq ~coq/validsdp
    cd ~coq/validsdp
    ./autogen.sh
    ./configure
    make install"
  travis_fold end validsdp
